<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>transite</title>


    <script src="GetOnlyFlag.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script type="text/javascript">
        var check = function (targetId) {
            //设备号
            var logflag = crc.get();
            //浏览器信息
            var userAgent = navigator.userAgent;
//            //IP地址
//            var cips = returnCitySN.cip;
            //地区
//            var cname = returnCitySN.cname;
            //客户端模式
            var mode = 'web';

            var sUserAgent = navigator.userAgent.toLowerCase();
            var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
            var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
            var bIsMidp = sUserAgent.match(/midp/i) == "midp";
            var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
            var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
            var bIsAndroid = sUserAgent.match(/android/i) == "android";
            var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
            var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
            if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {
                mode = 'wap';
            }
            console.log(logflag);
            console.log(userAgent);
//            console.log(cips);
//            console.log(cname);
            console.log(mode);

            $.ajax({
                url: 'http://120.24.67.105:8383/visitHistory/insertVisitHistory',
                type: 'post',
                data: {
                    "productId": targetId,
                    "requestId": logflag,
                    "requestIp": '',
                    "requestUrl": 'http://www.jrstreet.cn/webLink/transit.html?targetId=' + targetId,
                    "requestMode": mode,
                    "requestLocation": '',
                    "requestUserAgent": userAgent,
                },
                async: true,
                success: function () {
                    console.log('success');
                },
                error: function (e) {
                    console.log(e);
                }
            });
        };
    </script>
    <script type="text/javascript">
        var targetId = getUrlParam('targetId=');

        function getUrlParam(name) {
            var r = window.location.href.split(name)[1];
            if (r != null) {
                return r;
            } else {
                return null;
            }
        }

        check(targetId);
        getData(targetId);

        var xhr;
        productlink = ''

        function getData(targetId) {
            if (!targetId) {
                console.log('kong')
                return;
            }

            $.ajax({
                url: 'http://120.24.67.105:8383/weblink/findWeblinkByGiud',
                type: 'post',
                data: {
                    "guid": targetId
                },
                async: true,
                success: function (obj) {
                    if (obj == '此链接不存在' || obj == '此链接已关闭') {
//                        document.getElementById("controller").innerText = "此链接已关闭";
                        document.getElementById("controller").style.display = "block";
                        document.getElementById("content").style.display = "none";
                    } else {
                        productlink = obj;
//                        document.getElementById("controller").innerHTML = '<a href="' + obj + '">' + obj + '</a>';
                        document.getElementById("controller").style.display = "none";
                        document.getElementById("content").style.display = "block";
                        //window.location.replace(obj)
                    }
                },
                error: function (e) {
                    console.log(e);
                }
            });
        }

        var submitform = function () {
            //IP地址
            var cips = returnCitySN.cip;
            console.log(cips);
            //验证表单
            var name = document.getElementById("firstname").value;
            var telephone = document.getElementById("lastname").value;
            if (name == '' || name == undefined) {
                alert('请输入正确的姓名')
            } else if (telephone == '' || telephone == undefined) {
                alert('请输入正确的电话')
            } else if (!(/^1(3|4|5|7|8)\d{9}$/.test(telephone))) {
                alert("手机号码有误，请重填");
            } else {
                $.ajax({
                    url: 'http://120.24.67.105:8383/registerHistory/insert',
                    type: 'post',
                    data: {
                        "productId": targetId,
                        "name": name,
                        "telephone": telephone,
                        "ip": cips
                    },
                    async: true,
                    success: function (obj) {
                        console.log(obj);
                        if(obj=='yes') {
                            window.location.replace(productlink);
                        }
                        else {
                            alert("您已申请过，无法重复申请");
                        }
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
            }

        }
    </script>
</head>
<body style="text-align: center;font-size: 33px">
<div id="content" class="container" style="margin-top: 300px;">
    <div class="row">
        <div class="col-xs-2 col-sm-2"></div>
        <div class="col-xs-2 col-sm-2">姓名</div>
        <div class="col-xs-6 col-sm-6">
            <input type="text" id="firstname"
                   placeholder="请输入姓名">

        </div>
        <div class="col-xs-2 col-sm-2"></div>
    </div>
    <div class="row" style="margin-top: 15px">
        <div class="col-xs-2 col-sm-2"></div>
        <div class="col-xs-2 col-sm-2">手机</div>
        <div class="col-xs-6 col-sm-6">
            <input type="text" id="lastname"
                   placeholder="请输入手机号码">

        </div>

    </div>
    <div class="row" style="margin-top: 15px">
        <div class="col-xs-2 col-sm-2"></div>
        <div class="col-xs-8 col-sm-8">
            <button class="btn btn-default btn-lg" onclick="submitform()">确定</button>
        </div>
        <div class="col-xs-2 col-sm-2"></div>

    </div>
</div>
</div>
<div id="controller" style="margin-top: 400px;display: none">此链接已关闭</div>
</body>
</html>